!function e(n,t,r){function i(u,a){if(!t[u]){if(!n[u]){var s="function"==typeof require&&require;if(!a&&s)return s(u,!0);if(o)return o(u,!0);var c=new Error("Cannot find module '"+u+"'");throw c.code="MODULE_NOT_FOUND",c}var f=t[u]={exports:{}};n[u][0].call(f.exports,function(e){var t=n[u][1][e];return i(t||e)},f,f.exports,e,n,t,r)}return t[u].exports}for(var o="function"==typeof require&&require,u=0;u<r.length;u++)i(r[u]);return i}({1:[function(e,n,t){function r(e){return{status:404,error:"Index with name '"+e+"' already exists and can not be created again;"}}function i(e){var n=d(this);if(n)return g.reject(n);var t=y(this);return p(t).then(function(){return m(t,e)})}function o(e,n,t){var i=y(this);t=b.getFields(t);var o=JSON.stringify(t),u=d(this);return u?g.reject(u):p(i).then(function(){return m(i,e).then(function(){return g.reject(r(e))}).catch(function(e){if(404!==e.status)return g.reject(e)})}).then(function(){return v(i,"INSERT INTO 'relation-indexes' VALUES (?,?,?)",[e,n,o])}).then(function(){return h(i,"_ri_"+e,b.getFields(["id","rev"].concat(t)))})}function u(e){var n=y(this),t=this,r=d(this);return r?g.reject(r):m(n,e).then(function(e){return v(n,"DELETE FROM "+b.wrapTableName("_ri_"+e.index_name)).then(function(){return e})}).then(function(e){return f(t,n,e)})}function a(e,n,t){var r=d(this);if(r)return g.reject(r);var i=y(this);return m(i,e).then(function(r){var o="_ri_"+e,u=n?w.query(n,o):null,a=u?u.query:"",s=u?u.args:[];s.forEach(function(e){return e?e.toLowerCase():e}),a&&(a+=" AND ");var c=t?t.map(function(e){return b.wrapField(e,o)}).join():"";return c&&(c+=","),v(i,"SELECT `by-sequence`.seq AS seq, `by-sequence`.deleted AS deleted, `by-sequence`.json AS data, `by-sequence`.rev AS rev, `document-store`.id AS id, `document-store`.json AS metadata \nFROM `document-store` \nJOIN `by-sequence` ON `by-sequence`.seq = `document-store`.winningseq \nJOIN `_ri_"+e+"` ON `document-store`.id = `_ri_"+e+"`.id\nWHERE "+a+"`by-sequence`.deleted = 0 ORDER BY "+c+" `document-store`.id ASC",s)}).then(function(e){for(var n=[],t=0;t<e.rows.length;t++){var r=e.rows.item(t);n.push(b.unstringifyDoc(r.data,r.id,r.rev))}return n})}function s(e){var n=d(this);if(n)return g.reject(n);var t=y(this);return p(t).then(function(){return g.all([v(t,"DELETE FROM 'relation-indexes' WHERE index_name = ?",[e]),v(t,"DROP TABLE IF EXISTS `_ri_"+e+"`")])})}function c(e){var n=d(this);if(n)return g.reject(n);var t=y(this);return m(t,e).then(function(n){docTypeLen=n.doc_type.length;var r="SELECT `by-sequence`.seq AS seq, `by-sequence`.deleted AS deleted, `by-sequence`.json AS data, `by-sequence`.rev AS rev, `document-store`.id AS id, `document-store`.json AS metadata \nFROM `document-store` \nJOIN `by-sequence` ON `by-sequence`.seq = `document-store`.winningseq \nWHERE NOT EXISTS(SELECT 1 FROM `_ri_"+e+"` WHERE `document-store`.id = `_ri_"+e+"`.id ) AND substr(`document-store`.id, 1, "+docTypeLen+") = ? AND`by-sequence`.deleted = 0";return v(t,r,[n.doc_type]).then(function(e){for(var r=[],i=0;i<e.rows.length;i++){var o=e.rows.item(i);r.push(b.unstringifyDoc(o.data,o.id,o.rev))}if(r.length){var u=b.wrapTableName("_ri_"+n.index_name),a=b.getFields(["_id","_rev"].concat(n.fields)),s=r.map(function(e){var n=[],t=a.map(function(t){n.push("?");var r=b.resolve(e,t.name,null);return r?r.toString().toLowerCase():r});return["INSERT INTO "+u+" VALUES ("+n.join()+")",t]});return console.log(s),l(t,s)}})})}function f(e,n,t,r){return r=r||0,e.allDocs({startkey:t.doc_type,endkey:t.doc_type+"ï¿¿",include_docs:!0,skip:r,limit:1e3}).then(function(i){var o=i.rows.length;if(o){var u=b.wrapTableName("_ri_"+t.index_name),a=b.getFields(["_id","_rev"].concat(t.fields)),s=i.rows.map(function(e){var n=[],t=a.map(function(t){n.push("?");var r=b.resolve(e.doc,t.name,null);return r?r.toString().toLowerCase():r});return["INSERT INTO "+u+" VALUES ("+n.join()+")",t]});return l(n,s).then(function(){if(1e3===o)return f(e,n,t,r+1e3)})}})}function l(e,n){return new g(function(t,r){"function"==typeof e.sqlBatch?e.sqlBatch(n,function(){return t()},r):e.transaction(function(e){b.eachAsync(n,function(n,t){e.executeSql(n[0],n[1],function(){t()},function(e,n){t(n)})},function(e){e?r(e):t()})},function(e){r(e)})})}function d(e){if("websql"!==e.adapter&&"cordova-sqlite"!==e.adapter)return new Error("Relation Index plugin support only websql or cordova-sqlite adapters")}function p(e){return h(e,"relation-indexes",[{name:"index_name",type:"TEXT"},{name:"doc_type",type:"TEXT"},{name:"json",type:"TEXT"}])}function h(e,n,t){return v(e,"CREATE TABLE IF NOT EXISTS '"+n+"' ("+t.map(function(e){return"`"+e.name+"` "+e.type}).join()+")").then(function(){})}function v(e,n,t){return new g(function(r,i){e.transaction(function(e){e.executeSql(n,t||[],function(e,n){r(n)},function(e,n){i(n)})},function(e){i(e)})})}function y(e){return"cordova-sqlite"===e.adapter&&window.sqlitePlugin&&window.sqlitePlugin.openDatabase?window.sqlitePlugin.openDatabase({name:e._name,version:1,description:e._name,size:5e6}):E(e._name,"1","",5e6)}function m(e,n){return v(e,"SELECT * FROM 'relation-indexes' WHERE index_name = ?",[n]).then(function(e){if(!e.rows.length)return g.reject(r(n));var t=e.rows.item(0),i=JSON.parse(t.json);return{index_name:t.index_name,doc_type:t.doc_type,fields:i}})}var w=e("./query-builder.js"),b=e("./utils"),g=e("lie"),E=e("websql");t.getIndex=i,t.createIndex=o,t.buildIndex=u,t.queryIndex=a,t.deleteIndex=s,t.refreshIndex=c,"undefined"!=typeof window&&window.PouchDB&&window.PouchDB.plugin(t)},{"./query-builder.js":6,"./utils":7,lie:3,websql:5}],2:[function(e,n,t){(function(e){"use strict";function t(){f=!0;for(var e,n,t=l.length;t;){for(n=l,l=[],e=-1;++e<t;)n[e]();t=l.length}f=!1}function r(e){1!==l.push(e)||f||i()}var i,o=e.MutationObserver||e.WebKitMutationObserver;if(o){var u=0,a=new o(t),s=e.document.createTextNode("");a.observe(s,{characterData:!0}),i=function(){s.data=u=++u%2}}else if(e.setImmediate||void 0===e.MessageChannel)i="document"in e&&"onreadystatechange"in e.document.createElement("script")?function(){var n=e.document.createElement("script");n.onreadystatechange=function(){t(),n.onreadystatechange=null,n.parentNode.removeChild(n),n=null},e.document.documentElement.appendChild(n)}:function(){setTimeout(t,0)};else{var c=new e.MessageChannel;c.port1.onmessage=t,i=function(){c.port2.postMessage(0)}}var f,l=[];n.exports=r}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],3:[function(e,n,t){"use strict";function r(){}function i(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=w,this.queue=[],this.outcome=void 0,e!==r&&s(this,e)}function o(e,n,t){this.promise=e,"function"==typeof n&&(this.onFulfilled=n,this.callFulfilled=this.otherCallFulfilled),"function"==typeof t&&(this.onRejected=t,this.callRejected=this.otherCallRejected)}function u(e,n,t){h(function(){var r;try{r=n(t)}catch(n){return v.reject(e,n)}r===e?v.reject(e,new TypeError("Cannot resolve promise with itself")):v.resolve(e,r)})}function a(e){var n=e&&e.then;if(e&&"object"==typeof e&&"function"==typeof n)return function(){n.apply(e,arguments)}}function s(e,n){function t(n){o||(o=!0,v.reject(e,n))}function r(n){o||(o=!0,v.resolve(e,n))}function i(){n(r,t)}var o=!1,u=c(i);"error"===u.status&&t(u.value)}function c(e,n){var t={};try{t.value=e(n),t.status="success"}catch(e){t.status="error",t.value=e}return t}function f(e){return e instanceof this?e:v.resolve(new this(r),e)}function l(e){var n=new this(r);return v.reject(n,e)}function d(e){var n=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var t=e.length,i=!1;if(!t)return this.resolve([]);for(var o=new Array(t),u=0,a=-1,s=new this(r);++a<t;)!function(e,r){function a(e){o[r]=e,++u!==t||i||(i=!0,v.resolve(s,o))}n.resolve(e).then(a,function(e){i||(i=!0,v.reject(s,e))})}(e[a],a);return s}function p(e){var n=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var t=e.length,i=!1;if(!t)return this.resolve([]);for(var o=-1,u=new this(r);++o<t;)!function(e){n.resolve(e).then(function(e){i||(i=!0,v.resolve(u,e))},function(e){i||(i=!0,v.reject(u,e))})}(e[o]);return u}var h=e("immediate"),v={},y=["REJECTED"],m=["FULFILLED"],w=["PENDING"];n.exports=i,i.prototype.catch=function(e){return this.then(null,e)},i.prototype.then=function(e,n){if("function"!=typeof e&&this.state===m||"function"!=typeof n&&this.state===y)return this;var t=new this.constructor(r);if(this.state!==w){u(t,this.state===m?e:n,this.outcome)}else this.queue.push(new o(t,e,n));return t},o.prototype.callFulfilled=function(e){v.resolve(this.promise,e)},o.prototype.otherCallFulfilled=function(e){u(this.promise,this.onFulfilled,e)},o.prototype.callRejected=function(e){v.reject(this.promise,e)},o.prototype.otherCallRejected=function(e){u(this.promise,this.onRejected,e)},v.resolve=function(e,n){var t=c(a,n);if("error"===t.status)return v.reject(e,t.value);var r=t.value;if(r)s(e,r);else{e.state=m,e.outcome=n;for(var i=-1,o=e.queue.length;++i<o;)e.queue[i].callFulfilled(n)}return e},v.reject=function(e,n){e.state=y,e.outcome=n;for(var t=-1,r=e.queue.length;++t<r;)e.queue[t].callRejected(n);return e},i.resolve=f,i.reject=l,i.all=d,i.race=p},{immediate:2}],4:[function(e,n,t){"use strict";function r(e,n,t){var r=t[t.length-1];e===r.element&&(t.pop(),r=t[t.length-1]);var i=r.element,o=r.index;if(Array.isArray(i))i.push(e);else if(o===n.length-2){var u=n.pop();i[u]=e}else n.push(e)}t.stringify=function(e){var n=[];n.push({obj:e});for(var t,r,i,o,u,a,s,c,f,l,d,p="";t=n.pop();)if(r=t.obj,i=t.prefix||"",o=t.val||"",p+=i,o)p+=o;else if("object"!=typeof r)p+=void 0===r?null:JSON.stringify(r);else if(null===r)p+="null";else if(Array.isArray(r)){for(n.push({val:"]"}),u=r.length-1;u>=0;u--)a=0===u?"":",",n.push({obj:r[u],prefix:a});n.push({val:"["})}else{s=[];for(c in r)r.hasOwnProperty(c)&&s.push(c);for(n.push({val:"}"}),u=s.length-1;u>=0;u--)f=s[u],l=r[f],d=u>0?",":"",d+=JSON.stringify(f)+":",n.push({obj:l,prefix:d});n.push({val:"{"})}return p},t.parse=function(e){for(var n,t,i,o,u,a,s,c,f,l=[],d=[],p=0;;)if("}"!==(n=e[p++])&&"]"!==n&&void 0!==n)switch(n){case" ":case"\t":case"\n":case":":case",":break;case"n":p+=3,r(null,l,d);break;case"t":p+=3,r(!0,l,d);break;case"f":p+=4,r(!1,l,d);break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"-":for(t="",p--;;){if(i=e[p++],!/[\d\.\-e\+]/.test(i)){p--;break}t+=i}r(parseFloat(t),l,d);break;case'"':for(o="",u=void 0,a=0;;){if('"'===(s=e[p++])&&("\\"!==u||a%2!=1))break;o+=s,u=s,"\\"===u?a++:a=0}r(JSON.parse('"'+o+'"'),l,d);break;case"[":c={element:[],index:l.length},l.push(c.element),d.push(c);break;case"{":f={element:{},index:l.length},l.push(f.element),d.push(f);break;default:throw new Error("unexpectedly reached end of input: "+n)}else{if(1===l.length)return l.pop();r(l.pop(),l,d)}}},{}],5:[function(e,n,t){(function(e){"use strict";n.exports=e.openDatabase}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],6:[function(e,n,t){function r(e,n){var t=[];return{query:i(e,n,t),args:t}}function i(e,n,t){var r=[];for(var u in e)if(e.hasOwnProperty(u)){var a=e[u];if(["$or","$and"].indexOf(u)>-1&&!Array.isArray(a))throw new Error("Use of $and, $or operator requires an array as its parameter.");switch(r.length&&r.push(" AND "),u){case"$or":var s=a.map(function(e){return i(e,n,t)});s.length&&r.push("("+s.join(" OR ")+")");break;case"$and":s=a.map(function(e){return i(e,n,t)}),s.length&&r.push("("+s.join(") AND (")+")");break;default:r.push(o(u,a,n,t))}}return r.join("")}function o(e,n,t,r){var o="";switch(e){case"$lt":o+=" < ?",r.push(n+"");break;case"$gt":o+=" > ?",r.push(n+"");break;case"$lte":o+=" <= ?",r.push(n+"");break;case"$gte":o+=" >= ?",r.push(n+"");break;case"$ne":o+=" != ?",r.push(n+"");break;case"$in":o=o+" IN ["+n.map(function(){return"?"}).join()+"]",r.push(n.map(function(e){return e+""||null}).join());break;case"$nin":o=o+" NOT IN ["+n.map(function(){return"?"}).join()+"]",r.push(n.map(function(e){return e+""||null}).join());break;case"$like":o+=" LIKE ?",r.push(n+"");break;default:o=o+"`"+t+"`.`"+e+"`"+("object"==typeof n?i(n,t,r):" = ?"),"object"!=typeof n&&r.push(n+"")}return o}t.query=r},{}],7:[function(e,n,t){"use strict";function r(e){try{return JSON.parse(e)}catch(n){return i.parse(e)}}var i=e("vuvuzela"),o=t.getFields=function(e){return e.map(function(e){var n="string"==typeof e?{name:e,type:"TEXT"}:e;return n.type=(n.type||"TEXT").toUpperCase(),n})};t.wrapFields=function(e,n){var t=u(n);return o(e).map(function(e){return t+".`"+e.name+"`"})},t.wrapField=function(e,n){return u(n)+".`"+e+"`"};var u=t.wrapTableName=function(e){return e?"`"+e+"`":""};t.resolve=function(e,n,t){return n.split(".").reduce(function(e,n){return e&&e[n]},e)||t},t.eachAsync=function(e,n,t){var r=0,i=e.length,o=function(u){!u&&r<i?(n(e[r],o),r++):"function"==typeof t&&t(u)};o()},t.unstringifyDoc=function(e,n,t){return e=r(e),e._id=n,e._rev=t,e}},{vuvuzela:4}]},{},[1]);
